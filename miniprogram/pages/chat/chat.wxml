<view class="page">

<!-- 聊天列表 -->
<scroll-view
    class="chat"
    scroll-y="true"
    scroll-with-animation="true"
    scroll-into-view="{{toView}}"
  >
    <view class="chat-inner">
      <block wx:for="{{messages}}" wx:key="index">
        <view class="msg {{item.role === 'assistant' ? 'left' : 'right'}}">
          <view class="bubble">
            <!-- 必须用 rich-text + formatMarkdown -->
            <rich-text
              class="md"
              nodes="{{item.nodes}}"
            ></rich-text>

            <!-- 解锁提示 -->
            <view class="unlock-prompt" wx:if="{{item.truncated}}" bindtap="onUnlockMessage" data-index="{{index}}">
              <view class="unlock-icon">🔓</view>
              <text class="unlock-text">登录查看完整解读</text>
              <view class="unlock-arrow">→</view>
            </view>
          </view>
        </view>
      </block>

      <!-- Loading indicator -->
      <view wx:if="{{loading}}" class="msg left">
        <view class="bubble typing-bubble">
          <view class="typing-dots">
            <view class="dot"></view>
            <view class="dot"></view>
            <view class="dot"></view>
          </view>
        </view>
      </view>

      <view id="end"></view>
    </view>
</scroll-view>

<!-- 引导卡片 - 无命盘时显示 -->
<view class="guide-card" wx:if="{{showGuideCard && !hasPaipan}}">
  <view class="guide-icon">🎯</view>
  <view class="guide-title">开始您的命理解读之旅</view>
  <view class="guide-desc">
    还没有生成命盘，需要先完成排盘才能开始AI解读
  </view>
  <view class="guide-actions">
    <view class="guide-btn primary" bindtap="onGoToPaipan">
      前往排盘
    </view>
    <view class="guide-btn secondary" bindtap="onShowHistory">
      使用历史命盘
    </view>
  </view>
</view>

<!-- 操作按钮 -->
<view class="action-bar">
  <view class="action-btn" bindtap="onGoToResult">
    <text class="action-icon">📊</text>
    <text>我的命盘</text>
  </view>
  <!-- 隐藏命盘解读按钮
  <view class="action-btn" bindtap="onShowBaziDialog">
    <text class="action-icon">☯️</text>
    <text>命盘解读</text>
  </view>
  -->
  <view class="action-btn" bindtap="onClear">
    <text class="action-icon">🗑️</text>
    <text>清空对话</text>
  </view>
</view>

<!-- 快捷分析 -->
<view class="card quick-card">
  <view class="quick-title">快捷分析</view>
  <view class="quick-grid">
    <view class="quick-chip" bindtap="onQuickStart">命盘分析</view>
    <view class="quick-chip" bindtap="onQuickAsk" data-key="avatar" data-label="人物画像">人物画像</view>
    <view class="quick-chip" bindtap="onQuickAsk" data-key="love_timing" data-label="正缘应期">正缘应期</view>
    <view class="quick-chip" bindtap="onQuickAsk" data-key="career" data-label="事业建议">事业建议</view>
    <view class="quick-chip" bindtap="onQuickAsk" data-key="wealth" data-label="财运">财运</view>
    <view class="quick-chip" bindtap="onQuickAsk" data-key="health" data-label="健康">健康</view>
  </view>
</view>

<!-- 输入区 -->
<view class="inputBar">
  <input
    class="ipt"
    placeholder="来说点什么…"
    value="{{input}}"
    bindinput="onInput"
    confirm-type="send"
    bindconfirm="onSend"
  />
  <button class="sendBtn" bindtap="onSend" loading="{{loading}}" disabled="{{loading}}">
    发送
  </button>
</view>

<!-- 免责声明 -->
<view class="tip">* 对话仅供参考，不构成专业建议 *</view>

<view style="height: env(safe-area-inset-bottom)"></view>

<!-- 命盘解读弹窗 -->
<bazi-dialog id="baziDialog" bind:close="onBaziDialogClose"></bazi-dialog>

<!-- 登录弹窗 -->
<login-modal id="loginModal" bind:login="onLoginSuccess"></login-modal>
</view>
