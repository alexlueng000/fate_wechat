<view class="page">

<!-- 摘要条（点击展开/收起） -->
<view class="summary" bindtap="toggleSummary">
  <view class="sum-left">
    <text class="sum-title">命盘摘要</text>
    <view class="sum-pillars">
      <text class="p-tag">年</text><text class="p-val">{{pillars.year}}</text>
      <text class="p-tag">月</text><text class="p-val">{{pillars.month}}</text>
      <text class="p-tag">日</text><text class="p-val">{{pillars.day}}</text>
      <text class="p-tag">时</text><text class="p-val">{{pillars.hour}}</text>
    </view>
  </view>
  <text class="sum-toggle">{{summaryOpen ? '收起 ▲' : '展开 ▼'}}</text>
</view>

<!-- 折叠内容：四柱 + 大运 -->
<view wx:if="{{summaryOpen}}" class="card">
  <!-- 四柱表格 -->
  <view class="table">
    <view class="thead">
      <view class="th first">四柱</view>
      <view class="th">年柱</view>
      <view class="th">月柱</view>
      <view class="th">日柱</view>
      <view class="th">时柱</view>
    </view>
    <view class="trow">
      <view class="td first">天干</view>
      <!-- 改：wx:key="index" -->
      <view class="td" wx:for="{{table.tiangan}}" wx:key="index">{{item}}</view>
    </view>
    <view class="trow">
      <view class="td first">地支</view>
      <view class="td" wx:for="{{table.dizhi}}" wx:key="index">{{item}}</view>
    </view>
  </view>

  <!-- 大运（四列卡片） -->
  <view class="section">
    <view class="sec-title">大运</view>
    <view class="luck-grid">
      <block wx:for="{{dayun}}" wx:key="index">
        <view class="luck-card4">
          <text class="luck-ganzhi">{{item.ganzhi || '—'}}</text>
          <text class="luck-age">{{item.age}}</text>
        </view>
      </block>
    </view>
  </view>
</view>

<!-- 聊天区 -->
<scroll-view class="chat" scroll-y="true" scroll-into-view="{{scrollInto}}" enable-back-to-top="true">
  <view class="chat-inner">
    <!-- 改：wx:key="index"；并用明确的 index 变量 -->
    <block wx:for="{{messages}}" wx:key="index" wx:for-index="index" wx:for-item="msg">
      <view id="msg-{{index}}" class="msg {{msg.role === 'user' ? 'right' : 'left'}}">
        <view class="bubble">
          <!-- assistant 富文本（有 html 才渲染） -->
          <block wx:if="{{msg.role === 'assistant' && msg.html}}">
            <rich-text class="md" nodes="{{msg.html}}"></rich-text>
          </block>
          <!-- 兜底：文本 -->
          <block wx:elif="{{msg.role === 'assistant'}}">
            <text class="bubble-text">{{msg.content}}</text>
          </block>
          <block wx:elif="{{msg.role === 'user'}}">
            <text class="bubble-text">{{msg.content}}</text>
          </block>
        </view>
      </view>
    </block>
    <view id="bottom-anchor"></view>
  </view>
</scroll-view>

<!-- 生成解读 -->
<button class="cta" bindtap="onStartChat" loading="{{chatting}}" disabled="{{chatting}}">
  {{conversationId ? '重新生成解读' : '开始对话'}}
</button>

<!-- 输入条 -->
<!-- 快捷分析 -->
<view class="card quick-card">
  <view class="quick-title">快捷分析</view>
  <view class="quick-grid">
    <view class="quick-chip" bindtap="onQuickAsk" data-key="personality">性格特征</view>
    <view class="quick-chip" bindtap="onQuickAsk" data-key="avatar">人物画像</view>
    <view class="quick-chip" bindtap="onQuickAsk" data-key="partner_avatar">正缘人物画像</view>
    <view class="quick-chip" bindtap="onQuickAsk" data-key="career">事业建议</view>
    <view class="quick-chip" bindtap="onQuickAsk" data-key="wealth">财运</view>
    <view class="quick-chip" bindtap="onQuickAsk" data-key="health">健康</view>
    <view class="quick-chip wide" bindtap="onQuickAsk" data-key="love_timing">正缘应期</view>
  </view>
</view>

<!-- 输入与操作 -->
<view class="card composer">
  <textarea class="composer-textarea"
            placeholder="请输入你的问题，Shift+Enter 换行；Ctrl/Cmd+Enter 发送…"
            value="{{inputValue}}"
            bindinput="onInput"
            show-confirm-bar="false"
            cursor-spacing="16"
            auto-height="true" />
  <view class="composer-hint">回车发送（Shift+Enter 换行，Ctrl/Cmd+Enter 发送）</view>

  <view class="btn-row">
    <button class="btn btn-primary" bindtap="onSend" loading="{{sending}}" disabled="{{sending || !conversationId}}">发送</button>
    <button class="btn btn-ghost" bindtap="onStartChat" loading="{{chatting}}">重新解读</button>
    <button class="btn btn-outline" bindtap="onClearChat" disabled="{{messages.length===0}}">清空对话</button>
  </view>
</view>


<view style="height: env(safe-area-inset-bottom)"></view>
</view>
